---
title: "R Notebook"
output: html_notebook
---



```{r library}
#| echo: false
#| warning: false
#| include: false


library(tidyverse)
library(ggplot2)
library(dplyr)
library(openxlsx)
library(stargazer)
library(readxl)
library(data.table)
library(stringr)

```

``` {r test}

list.files()

```

Data Preparation

4 different types of data are used: housing market, occupation and wage, economic, and demographic.
Each type of data contain multiple csv or excel each ranging from 20 rows to 942600 rows. 
Files  are renamed, converted, and combined to one csv file per type for ease of use in the future. 

```{r load raw data}

# load housing market data

folder = "hmda_housing_market"
setwd(folder)

files = list.files()

for (f in files) {
  base = basename(f)
  print(base)
  df_name = paste0("housing_market_", substr(base, 10, 13))
  print(df_name)
  df = read.csv(f)
  head(df)
  assign(df_name, df)
}



# load occupation data


folder = "occupation_wage/csv"
print(folder)
setwd(folder)
getwd()

files = list.files()
files


### initially used to convert all excel files to csv for fasting reading and parsing later
# for (f in files) {
#   base = basename(f)
#   print(paste0("processing file ", base))
#   df_name = paste0("occup_wage_", substr(base, 12, 15))
#   temp = read_excel(f, col_type="text")
#   write.csv(temp, paste0("H:/Bank/Great Western Data Challenge/occupation_wage/", df_name, ".csv"), row.names=FALSE)
#   print(paste0("saved to H:/Bank/Great Western Data Challenge/occupation_wage/", df_name, ".csv"))
#   df = fread("temp.csv")
#   head(df)
#   assign(df_name, df)
# }

for (f in files) {
  base = basename(f)
  print(base)
  df_name = paste0("occ_wage_", substr(base, 12, 15))
  print(df_name)
  df = read.csv(f)
  head(df)
  assign(df_name, df)
}



# load economy data

folder = "economics_tracker"
setwd(folder)

files = list.files()

for (f in files) {
  df_name = paste0("economics_", f, sep = "")
  print(df_name)
  df = read.csv(f)
  head(df)
  assign(df_name, df)
}




# load demographics data

folder = "demographics"
setwd(folder)

files = list.files()

for (f in files) {
  base = basename(f)
  print(base)
  df_name = paste("demographics_", substr(base, 8, 11), sep = "")
  print(df_name)
  df = read.csv(f)
  head(df)
  assign(df_name, df)
}


```

``` {r merge and save}

# Occupation and Wage data
# Add year as column before merging

dfs = mget(ls(pattern = "^occ_wage_\\d{4}$"))

dfs = lapply(names(dfs), function(name) {
  year = sub(".*_(\\d{4})$", "\\1", name)
  df = dfs[[name]]
  names(df) = tolower(names(df))
  df$year = as.integer(year)
  return(df)
} )

df_all = rbindlist(dfs, fill=TRUE)

write_csv(df_all, "occupation_wage_2014_to_2024.csv")



# Demographics data
# Add year as column before merging

dfs = mget(ls(pattern = "^demographics_\\d{4}$"))

dfs = lapply(names(dfs), function(name) {
  year = sub(".*_(\\d{4})$", "\\1", name)
  df = dfs[[name]]
  names(df) = tolower(names(df))
  df$year = as.integer(year)
  return(df)
} )

df_all = rbindlist(dfs, fill=TRUE)

write_csv(df_all, "demographics_2011_to_2024.csv")



# Housing Market data

dfs = mget(ls(pattern = "^housing_market_\\d{4}$"))

for (name in names(dfs)) {
  df <- get(name)
  old_name <- names(df)[tolower(names(df)) == "activity_year"]
  
  if (length(old_name) == 1) {
    names(df)[names(df) == old_name] = "year"
  }
  assign(name, df)
} 

df_all = rbindlist(dfs, fill=TRUE)

write_csv(df_all, "housing_market_2018_to_2024.csv")

```

``` {r load data}

# load demographics data

demographics = fread("demographics_2011_to_2024.csv")
housing_market = fread("housing_market_2018_to_2024.csv")
occu_wage = fread("occupation_wage_2014_to_2024.csv")


# load economics data

folder = "economics_tracker"
setwd(folder)

files = list.files()

for (f in files) {
  df_name = f
  df = fread(f)
  head(df)
  assign(df_name, df)
}


```




``` {r prep data}


occ_wage_filtered <- occu_wage %>%
  select(year, area_title, occ.title, group, tot_emp, jobs_1000, percent_total = loc_quotient, hr_mean = h_mean, a_mean = a_mean) %>%
  filter(str_detect(tolower(area_title), "u\\.s\\.?$|,\\s*wa$|\\bwashington\\b"))

head(occ_wage_filtered)

```


